{% extends "data/dashboard/base.html" %}
{% block dashboard_content %}
<div class="max-w-2xl mx-auto p-4">
  <h1 class="text-2xl font-bold mb-4">Inisiasi Algoritma Genetika Penjadwalan</h1>
  <div class="mb-4">
    <!-- Tambahkan tombol Batal, sembunyikan secara default -->
    <button id="start-btn" class="btn btn-primary">Mulai Algoritma Genetika</button>
    <button id="cancel-btn" class="btn btn-error" style="display: none;">Batalkan Proses</button>
    <span id="status" class="ml-4 text-sm"></span>
  </div>
  <div class="bg-base-200 rounded p-4 h-96 overflow-y-auto" id="progress-box">
    <pre id="progress-log" class="text-xs"></pre>
  </div>
</div>
<script>
const startBtn = document.getElementById('start-btn');
const cancelBtn = document.getElementById('cancel-btn'); // Ambil elemen tombol batal
const progressLog = document.getElementById('progress-log');
const statusSpan = document.getElementById('status');
let eventSource = null;

function startGenetika() {
  startBtn.style.display = 'none'; // Sembunyikan tombol mulai
  cancelBtn.style.display = 'inline-block'; // Tampilkan tombol batal
  cancelBtn.disabled = false;
  
  statusSpan.textContent = 'Memulai...';
  progressLog.textContent = ''; // Bersihkan log sebelumnya

  fetch('{% url "genetika_start" %}', {
    method: 'POST', 
    headers: {'X-CSRFToken': '{{ csrf_token }}'}
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.status === 'started') {
      listenProgress();
      statusSpan.textContent = 'Proses berjalan...';
    } else if (data.status === 'already_running') {
      statusSpan.textContent = 'Algoritma sudah berjalan.';
      listenProgress();
    } else {
      statusSpan.textContent = 'Gagal memulai.';
      startBtn.style.display = 'inline-block';
      cancelBtn.style.display = 'none';
    }
  });
}

function cancelGenetika() {
  cancelBtn.disabled = true; // Nonaktifkan tombol setelah diklik
  statusSpan.textContent = 'Membatalkan...';
  fetch('{% url "genetika_cancel" %}', { // Ganti dengan URL view cancel Anda
    method: 'POST',
    headers: {'X-CSRFToken': '{{ csrf_token }}'}
  })
  .then(resp => resp.json())
  .then(data => {
    if (data.status === 'cancel_requested') {
      statusSpan.textContent = 'Permintaan pembatalan terkirim... Menunggu proses berhenti.';
    } else {
      statusSpan.textContent = 'Gagal mengirim permintaan batal.';
      cancelBtn.disabled = false;
    }
  });
}

function listenProgress() {
  eventSource = new EventSource('{% url "genetika_progress" %}');
  
  eventSource.onmessage = function(e) {
    if (e.data === '__DONE__') {
      statusSpan.textContent = 'Selesai.';
      startBtn.style.display = 'inline-block'; // Tampilkan lagi tombol start
      cancelBtn.style.display = 'none'; // Sembunyikan tombol batal
      if(eventSource) eventSource.close();
    } else {
      progressLog.textContent += e.data + '\n';
      progressLog.scrollTop = progressLog.scrollHeight;
    }
  };

  eventSource.onerror = function() {
    statusSpan.textContent = 'Koneksi terputus.';
    startBtn.style.display = 'inline-block';
    cancelBtn.style.display = 'none';
    if(eventSource) eventSource.close();
  };
}

startBtn.addEventListener('click', startGenetika);
cancelBtn.addEventListener('click', cancelGenetika); // Tambahkan event listener untuk tombol batal

</script>
{% endblock %}
